name: sprawozdanie_pdf
on: push

jobs:
  sprawozdanie:
    runs-on: ubuntu-latest

    steps:
      - name: Update apt
        run: sudo apt-get update

      - name: Install TeX + tools
        run: sudo apt-get install -y texlive-xetex inkscape pandoc

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Python deps
        run: |
          pip install \
            matplotlib \
            pint \
            open-atmos-jupyter-utils \
            scipy \
            nbconvert \
            ipykernel \
            pympdata

      - name: Execute notebook and export to LaTeX
        run: |
          jupyter nbconvert \
            projekt/projekt_mup.ipynb \
            --execute \
            --to latex \
            --no-input \
            --no-prompt \
            --TagRemovePreprocessor.enabled=True \
            --TagRemovePreprocessor.remove_cell_tags='["no-pdf"]' \
            --ExecutePreprocessor.timeout=600 \
            --output projekt_mup \
            --output-dir projekt

      - name: Clean LaTeX (remove HTML junk, title/date and HBox blocks)
        run: |
          sed -i '/\\title{/d'  projekt/projekt_mup.tex
          sed -i '/\\author{/d' projekt/projekt_mup.tex
          sed -i '/\\date{/d'   projekt/projekt_mup.tex
          sed -i '/\\maketitle/d' projekt/projekt_mup.tex

          python - << 'EOF'
          from pathlib import Path
          import re
          
          path = Path("projekt/projekt_mup.tex")
          tex = path.read_text()
          
          verb_pattern = re.compile(
              r"\\begin{[Vv]erbatim}[\s\S]*?\\end{[Vv]erbatim}",
              re.MULTILINE)
          
          def drop_hbox_verbatim(m):
              block = m.group(0)
              if "HBox(children=" in block:
                  return "" 
              return block  
          
          tex = verb_pattern.sub(drop_hbox_verbatim, tex)
          tex = re.sub(r".*HBox\(children=.*\n", "", tex)
          
          path.write_text(tex)
          EOF

      - name: Insert custom title and author
        run: |
          sed -i '0,/\\begin{document}/s//\\begin{document}\n\\title{Jaka będzie różnica w czasie dotarcia fali do brzegu w zależności od ukształtowania stoku dna?}\n\\author{Wiktoria Maksymiak}\n\\date{}\n\\maketitle\n/' projekt/projekt_mup.tex

      - name: Build PDF with xelatex
        run: |
          cd projekt
          xelatex -interaction=nonstopmode projekt_mup.tex

      - name: Upload PDF + graphics artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sprawozdanie
          path: |
            projekt/projekt_mup.pdf
            projekt/grafiki/*
